<!DOCTYPE html>
<html>
<head>
<meta charset='utf-8' />
<title>ERCOT TPIT map</title>
<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.38.0/mapbox-gl.js'></script>
<script src='tx_counties.js'></script>
<script src='tpit.js'></script>
<link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.38.0/mapbox-gl.css' rel='stylesheet' />
<style>
html, body {
	width: 100%;
	height: 100%;
	margin: 0;
	padding: 0;
}
#map { position:absolute; top:0; bottom:0; width:100%; }
</style>
</head>
<body>
<div id='map' class='map'></div>
<script>
mapboxgl.accessToken = 'pk.eyJ1Ijoia3JlM2QiLCJhIjoiY2lwcjJrZ3p2MDZyOWZvbTN0bXV1eXF6ZiJ9.xXv_HMXLK04bEtmuwsEyMQ';
var map = new mapboxgl.Map({
	container: 'map',
	style: 'basic.json',
	hash: true,
	center: [-98.34, 30.55],
	zoom: 6
});

var county_projects = {};
for (var i = 0; i < tpit_projects.length; ++i) {
	var e = tpit_projects[i];
	var county = e.county_start;
	if (!county_projects.hasOwnProperty(county)) {
		county_projects[county] = [];
	}
	county_projects[county].push(e);
}

for (var i = 0; i < counties.features.length; ++i) {
	var county_feature = counties.features[i];
	var county_name = county_feature.properties["COUNTY"];
	county_feature.properties.projects = 0;
	if (county_projects.hasOwnProperty(county_name)) {
		var projects = county_projects[county_name];
		for (var j = 0; j < projects.length; ++j) {
			if (projects[j].sheet_status != 'Cancelled') {
				county_feature.properties.projects++;
			}
		}
	}
}

map.on('style.load', function () {
	map.addSource("counties", {
		"type": "geojson",
		"data": counties
	});

	map.addLayer({
		"id": "county",
		"type": "fill",
		"source": "counties",
		"paint": {
			"fill-outline-color": "#000",
			'fill-color': {
				property: 'projects',
				stops: [
					[0, '#888888'],
					[1, '#F2F12D'],
					[2, '#EED322'],
					[3, '#E6B71E'],
					[5, '#DA9C20'],
					[8, '#CA8323'],
					[15, '#B86B25'],
					[20, '#A25626'],
					[35, '#8B4225'],
					[50, '#723122']
				]
			},
			"fill-opacity": 0.4
		},
	});
});

map.on('click', function (e) {
	var features = map.queryRenderedFeatures(e.point, { layers: ['county'] });
	if (features.length) {
		var feature = features[0];
		var county = features[0].properties['COUNTY'];

		var html = '';
		var projects = county_projects[county];
		if (!projects) {
			return;
		}
		console.log(projects);
		for (var i = 0; i < projects.length; ++i) {
			var p = projects[i];
			var rows = [p.title, p.transmission_owner, p.projected_in_service, p.sheet_status];
			html += '<tr title="' + p.description + '"><td>' + rows.join('</td><td>') + '</td></tr>';
		}

		new mapboxgl.Popup()
			.setLngLat(e.lngLat)
			.setHTML('<table>' + html + '</table>')
			.addTo(map);
	}
});
</script>
</body>
</html>
